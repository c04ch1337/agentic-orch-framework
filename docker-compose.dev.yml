version: '3.9'

# PHOENIX ORCH Docker Compose - Development Configuration
# All host ports are configurable via .env file
# Copy .env.example to .env and modify ports as needed
# Security and resource limits implemented for development environment

services:
  # --- Core Services ---
  orchestrator:
    build:
      context: .
      dockerfile: ./orchestrator-service-rs/Dockerfile.dev
    image: orchestrator-service-rs:latest
    container_name: orchestrator-service
    ports:
      - "${ORCHESTRATOR_PORT:-50051}:50051"
    environment:
      - DATA_ROUTER_ADDR=http://data-router:50052
      - REFLECTION_SERVICE_ADDR=http://reflection:50065
      - RUST_LOG=${RUST_LOG:-info}
    volumes:
      - .:/app/system-build-rs:ro
      - orchestrator_data:/app/data
    networks:
      - agi_network
      - orchestrator_network
    depends_on:
      data-router:
        condition: service_healthy
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.1'
    restart: on-failure:5
    healthcheck:
      test: [ "CMD", "wget", "--spider", "-q", "http://localhost:50051" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s

  data-router:
    build:
      context: .
      dockerfile: ./data-router-rs/Dockerfile.dev
    image: data-router-rs:latest
    container_name: data-router-service
    ports:
      - "${DATA_ROUTER_PORT:-50052}:50052"
    environment:
      - LLM_SERVICE_ADDR=http://llm-service:50053
      - TOOLS_SERVICE_ADDR=http://tools-service:50054
      - SAFETY_SERVICE_ADDR=http://safety-service:50055
      - LOGGING_SERVICE_ADDR=http://logging-service:50056
      - MIND_KB_ADDR=http://mind-kb:50057
      - BODY_KB_ADDR=http://body-kb:50058
      - HEART_KB_ADDR=http://heart-kb:50059
      - SOCIAL_KB_ADDR=http://social-kb:50060
      - SOUL_KB_ADDR=http://soul-kb:50061
      - CONTEXT_MANAGER_ADDR=http://context-manager:50064
      - RUST_LOG=${RUST_LOG:-info}
    volumes:
      - .:/app/system-build-rs:ro
      - data_router_data:/app/data
    networks:
      - agi_network
      - data_router_network
    depends_on:
      llm-service:
        condition: service_healthy
      safety-service:
        condition: service_healthy
      logging-service:
        condition: service_healthy
    deploy:
      resources:
        limits:
          memory: 768M
          cpus: '0.7'
        reservations:
          memory: 384M
          cpus: '0.2'
    restart: on-failure:5
    healthcheck:
      test: [ "CMD", "wget", "--spider", "-q", "http://localhost:50052" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s

  llm-service:
    build:
      context: .
      dockerfile: ./llm-service-rs/Dockerfile.dev
    image: llm-service-rs:latest
    container_name: llm-service
    ports:
      - "${LLM_SERVICE_PORT:-50053}:50053"
    environment:
      - LLM_SERVICE_ADDR=0.0.0.0:50053
      - LLM_API_URL=${LLM_API_URL:-https://openrouter.ai/api/v1/chat/completions}
      - LLM_API_KEY=${LLM_API_KEY:-}
      - LLM_MODEL=${LLM_MODEL:-anthropic/claude-3.5-sonnet}
      - RUST_LOG=${RUST_LOG:-info}
    volumes:
      - .:/app/system-build-rs:ro
      - llm_service_data:/app/data
    networks:
      - agi_network
      - llm_service_network
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1.0'
        reservations:
          memory: 512M
          cpus: '0.3'
    restart: on-failure:5
    healthcheck:
      test: [ "CMD", "wget", "--spider", "-q", "http://localhost:50053" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s

  tools-service:
    build:
      context: .
      dockerfile: ./tools-service-rs/Dockerfile.dev
    image: tools-service-rs:latest
    container_name: tools-service
    ports:
      - "${TOOLS_SERVICE_PORT:-50054}:50054"
    environment:
      - TOOLS_SERVICE_ADDR=0.0.0.0:50054
      - EXECUTOR_ADDR=http://executor:50062
      - RUST_LOG=${RUST_LOG:-info}
    volumes:
      - .:/app/system-build-rs:ro
      - tools_service_data:/app/data
    networks:
      - agi_network
      - tools_service_network
    depends_on:
      executor:
        condition: service_healthy
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.1'
    restart: on-failure:5
    healthcheck:
      test: [ "CMD", "wget", "--spider", "-q", "http://localhost:50054" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s

  safety-service:
    build:
      context: .
      dockerfile: ./safety-service-rs/Dockerfile.dev
    image: safety-service-rs:latest
    container_name: safety-service
    ports:
      - "${SAFETY_SERVICE_PORT:-50055}:50055"
    environment:
      - SAFETY_SERVICE_ADDR=0.0.0.0:50055
      - RUST_LOG=${RUST_LOG:-info}
    volumes:
      - .:/app/system-build-rs:ro
      - safety_service_data:/app/data
    networks:
      - agi_network
      - safety_service_network
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.2'
    restart: on-failure:5
    healthcheck:
      test: [ "CMD", "wget", "--spider", "-q", "http://localhost:50055" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s

  logging-service:
    build:
      context: .
      dockerfile: ./logging-service-rs/Dockerfile.dev
    image: logging-service-rs:latest
    container_name: logging-service
    ports:
      - "${LOGGING_SERVICE_PORT:-50056}:50056"
    environment:
      - LOGGING_SERVICE_ADDR=0.0.0.0:50056
      - RUST_LOG=${RUST_LOG:-info}
    volumes:
      - .:/app/system-build-rs:ro
      - logging_service_data:/app/data
    networks:
      - agi_network
      - logging_service_network
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.1'
    restart: on-failure:5
    healthcheck:
      test: [ "CMD", "wget", "--spider", "-q", "http://localhost:50056" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s

  # --- Knowledge Bases ---
  mind-kb:
    build:
      context: .
      dockerfile: ./mind-kb-rs/Dockerfile.dev
    image: mind-kb-rs:latest
    container_name: mind-kb
    ports:
      - "${MIND_KB_PORT:-50057}:50057"
    environment:
      - MIND_KB_ADDR=0.0.0.0:50057
      - RUST_LOG=${RUST_LOG:-info}
    volumes:
      - .:/app/system-build-rs:ro
      - mind_kb_data:/app/data
    networks:
      - agi_network
      - mind_kb_network
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.1'
    restart: on-failure:5
    healthcheck:
      test: [ "CMD", "wget", "--spider", "-q", "http://localhost:50057" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s

  body-kb:
    build:
      context: .
      dockerfile: ./body-kb-rs/Dockerfile.dev
    image: body-kb-rs:latest
    container_name: body-kb
    ports:
      - "${BODY_KB_PORT:-50058}:50058"
    environment:
      - BODY_KB_ADDR=0.0.0.0:50058
      - RUST_LOG=${RUST_LOG:-info}
    volumes:
      - .:/app/system-build-rs:ro
      - body_kb_data:/app/data
    networks:
      - agi_network
      - body_kb_network
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.1'
    restart: on-failure:5
    healthcheck:
      test: [ "CMD", "wget", "--spider", "-q", "http://localhost:50058" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s

  heart-kb:
    build:
      context: .
      dockerfile: ./heart-kb-rs/Dockerfile.dev
    image: heart-kb-rs:latest
    container_name: heart-kb
    ports:
      - "${HEART_KB_PORT:-50059}:50059"
    environment:
      - HEART_KB_ADDR=0.0.0.0:50059
      - RUST_LOG=${RUST_LOG:-info}
    volumes:
      - .:/app/system-build-rs:ro
      - heart_kb_data:/app/data
    networks:
      - agi_network
      - heart_kb_network
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.1'
    restart: on-failure:5
    healthcheck:
      test: [ "CMD", "wget", "--spider", "-q", "http://localhost:50059" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s

  social-kb:
    build:
      context: .
      dockerfile: ./social-kb-rs/Dockerfile.dev
    image: social-kb-rs:latest
    container_name: social-kb
    ports:
      - "${SOCIAL_KB_PORT:-50060}:50060"
    environment:
      - SOCIAL_KB_ADDR=0.0.0.0:50060
      - RUST_LOG=${RUST_LOG:-info}
    volumes:
      - .:/app/system-build-rs:ro
      - social_kb_data:/app/data
    networks:
      - agi_network
      - social_kb_network
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.1'
    restart: on-failure:5
    healthcheck:
      test: [ "CMD", "wget", "--spider", "-q", "http://localhost:50060" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s

  soul-kb:
    build:
      context: .
      dockerfile: ./soul-kb-rs/Dockerfile.dev
    image: soul-kb-rs:latest
    container_name: soul-kb
    ports:
      - "${SOUL_KB_PORT:-50061}:50061"
    environment:
      - SOUL_KB_ADDR=0.0.0.0:50061
      - RUST_LOG=${RUST_LOG:-info}
    volumes:
      - .:/app/system-build-rs:ro
      - soul_kb_data:/app/data
    networks:
      - agi_network
      - soul_kb_network
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.1'
    restart: on-failure:5
    healthcheck:
      test: [ "CMD", "wget", "--spider", "-q", "http://localhost:50061" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s

  # --- Phase 4 Services ---
  executor:
    build:
      context: .
      dockerfile: ./executor-rs/Dockerfile.dev
    image: executor-rs:latest
    container_name: executor-service
    ports:
      - "${EXECUTOR_PORT:-50062}:50062"
    environment:
      - EXECUTOR_ADDR=0.0.0.0:50062
      - RUST_LOG=${RUST_LOG:-info}
    volumes:
      - .:/app/system-build-rs:ro
      - executor_data:/app/data
    networks:
      - agi_network
      - executor_network
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.2'
    restart: on-failure:5
    healthcheck:
      test: [ "CMD", "wget", "--spider", "-q", "http://localhost:50062" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s

  # --- Phase 5 Services ---
  context-manager:
    build:
      context: .
      dockerfile: ./context-manager-rs/Dockerfile.dev
    image: context-manager-rs:latest
    container_name: context-manager-service
    ports:
      - "${CONTEXT_MANAGER_PORT:-50064}:50064"
    environment:
      - CONTEXT_MANAGER_ADDR=0.0.0.0:50064
      - MIND_KB_ADDR=http://mind-kb:50057
      - BODY_KB_ADDR=http://body-kb:50058
      - HEART_KB_ADDR=http://heart-kb:50059
      - SOCIAL_KB_ADDR=http://social-kb:50060
      - SOUL_KB_ADDR=http://soul-kb:50061
      - RUST_LOG=${RUST_LOG:-info}
    volumes:
      - .:/app/system-build-rs:ro
      - context_manager_data:/app/data
    networks:
      - agi_network
      - context_manager_network
    depends_on:
      mind-kb:
        condition: service_healthy
      body-kb:
        condition: service_healthy
      heart-kb:
        condition: service_healthy
      social-kb:
        condition: service_healthy
      soul-kb:
        condition: service_healthy
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.1'
    restart: on-failure:5
    healthcheck:
      test: [ "CMD", "wget", "--spider", "-q", "http://localhost:50064" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s

  reflection:
    build:
      context: .
      dockerfile: ./reflection-rs/Dockerfile.dev
    image: reflection-rs:latest
    container_name: reflection-service
    ports:
      - "${REFLECTION_PORT:-50065}:50065"
    environment:
      - REFLECTION_SERVICE_ADDR=0.0.0.0:50065
      - RUST_LOG=${RUST_LOG:-info}
    volumes:
      - .:/app/system-build-rs:ro
      - reflection_data:/app/data
    networks:
      - agi_network
      - reflection_network
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.1'
    restart: on-failure:5
    healthcheck:
      test: [ "CMD", "wget", "--spider", "-q", "http://localhost:50065" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s

  scheduler:
    build:
      context: .
      dockerfile: ./scheduler-rs/Dockerfile.dev
    image: scheduler-rs:latest
    container_name: scheduler-service
    ports:
      - "${SCHEDULER_PORT:-50066}:50066"
    environment:
      - SCHEDULER_SERVICE_ADDR=0.0.0.0:50066
      - RUST_LOG=${RUST_LOG:-info}
    volumes:
      - .:/app/system-build-rs:ro
      - scheduler_data:/app/data
    networks:
      - agi_network
      - scheduler_network
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.1'
    restart: on-failure:5
    healthcheck:
      test: [ "CMD", "wget", "--spider", "-q", "http://localhost:50066" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s

  agent-registry:
    build:
      context: .
      dockerfile: ./agent-registry-rs/Dockerfile.dev
    image: agent-registry-rs:latest
    container_name: agent-registry-service
    ports:
      - "${AGENT_REGISTRY_PORT:-50067}:50067"
    environment:
      - AGENT_REGISTRY_ADDR=0.0.0.0:50067
      - AGENT_REGISTRY_CONFIG=/app/system-build-rs/config/agent_registry.toml
      - RUST_LOG=${RUST_LOG:-info}
    volumes:
      - .:/app/system-build-rs:ro
      - agent_registry_data:/app/data
      - ./config:/app/system-build-rs/config:ro
    networks:
      - agi_network
      - agent_registry_network
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.1'
    restart: on-failure:5
    healthcheck:
      test: [ "CMD", "wget", "--spider", "-q", "http://localhost:50067" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s

volumes:
  orchestrator_data:
  data_router_data:
  llm_service_data:
  tools_service_data:
  safety_service_data:
  logging_service_data:
  mind_kb_data:
  body_kb_data:
  heart_kb_data:
  social_kb_data:
  soul_kb_data:
  executor_data:
  context_manager_data:
  reflection_data:
  scheduler_data:
  agent_registry_data:


networks:
  agi_network:
    name: agi_network
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 172.20.0.0/16

  orchestrator_network:
    internal: true
  data_router_network:
    internal: true
  llm_service_network:
    internal: true
  tools_service_network:
    internal: true
  safety_service_network:
    internal: true
  logging_service_network:
    internal: true
  mind_kb_network:
    internal: true
  body_kb_network:
    internal: true
  heart_kb_network:
    internal: true
  social_kb_network:
    internal: true
  soul_kb_network:
    internal: true
  executor_network:
    internal: true
  context_manager_network:
    internal: true
  reflection_network:
    internal: true
  scheduler_network:
    internal: true
  agent_registry_network:
    internal: true
